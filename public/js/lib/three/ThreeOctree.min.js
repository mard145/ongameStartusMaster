/*!
 *
 * ThreeOctree.js / https://github.com/collinhover/threeoctree
 * (sparse) dynamic 3D spatial representation structure for fast searches.
 *
 * @author Collin Hover / http://collinhover.com/
 * based on Dynamic Octree by Piko3D @ http://www.piko3d.com/ and Octree by Marek Pawlowski @ pawlowski.it
 *
 */
(function(c){function b(e){return !isNaN(e)&&isFinite(e)}function a(e){return Object.prototype.toString.call(e)==="[object Array]"}function d(e){return e?(a(e)!==true?[e]:e):[]}c.Octree=function(e){e=e||{};e.tree=this;this.nodeCount=0;this.INDEX_INSIDE_CROSS=-1;this.INDEX_OUTSIDE_OFFSET=2;this.INDEX_OUTSIDE_POS_X=b(e.INDEX_OUTSIDE_POS_X)?e.INDEX_OUTSIDE_POS_X:0;this.INDEX_OUTSIDE_NEG_X=b(e.INDEX_OUTSIDE_NEG_X)?e.INDEX_OUTSIDE_NEG_X:1;this.INDEX_OUTSIDE_POS_Y=b(e.INDEX_OUTSIDE_POS_Y)?e.INDEX_OUTSIDE_POS_Y:2;this.INDEX_OUTSIDE_NEG_Y=b(e.INDEX_OUTSIDE_NEG_Y)?e.INDEX_OUTSIDE_NEG_Y:3;this.INDEX_OUTSIDE_POS_Z=b(e.INDEX_OUTSIDE_POS_Z)?e.INDEX_OUTSIDE_POS_Z:4;this.INDEX_OUTSIDE_NEG_Z=b(e.INDEX_OUTSIDE_NEG_Z)?e.INDEX_OUTSIDE_NEG_Z:5;this.INDEX_OUTSIDE_MAP=[];this.INDEX_OUTSIDE_MAP[this.INDEX_OUTSIDE_POS_X]={index:this.INDEX_OUTSIDE_POS_X,count:0,x:1,y:0,z:0};this.INDEX_OUTSIDE_MAP[this.INDEX_OUTSIDE_NEG_X]={index:this.INDEX_OUTSIDE_NEG_X,count:0,x:-1,y:0,z:0};this.INDEX_OUTSIDE_MAP[this.INDEX_OUTSIDE_POS_Y]={index:this.INDEX_OUTSIDE_POS_Y,count:0,x:0,y:1,z:0};this.INDEX_OUTSIDE_MAP[this.INDEX_OUTSIDE_NEG_Y]={index:this.INDEX_OUTSIDE_NEG_Y,count:0,x:0,y:-1,z:0};this.INDEX_OUTSIDE_MAP[this.INDEX_OUTSIDE_POS_Z]={index:this.INDEX_OUTSIDE_POS_Z,count:0,x:0,y:0,z:1};this.INDEX_OUTSIDE_MAP[this.INDEX_OUTSIDE_NEG_Z]={index:this.INDEX_OUTSIDE_NEG_Z,count:0,x:0,y:0,z:-1};this.FLAG_POS_X=1<<(this.INDEX_OUTSIDE_POS_X+1);this.FLAG_NEG_X=1<<(this.INDEX_OUTSIDE_NEG_X+1);this.FLAG_POS_Y=1<<(this.INDEX_OUTSIDE_POS_Y+1);this.FLAG_NEG_Y=1<<(this.INDEX_OUTSIDE_NEG_Y+1);this.FLAG_POS_Z=1<<(this.INDEX_OUTSIDE_POS_Z+1);this.FLAG_NEG_Z=1<<(this.INDEX_OUTSIDE_NEG_Z+1);this.utilVec31Search=new c.Vector3();this.utilVec32Search=new c.Vector3();this.scene=e.scene;this.objects=[];this.objectsData=[];this.depthMax=b(e.depthMax)?e.depthMax:-1;this.objectsThreshold=b(e.objectsThreshold)?e.objectsThreshold:8;this.overlapPct=b(e.overlapPct)?e.overlapPct:0.15;this.root=e.root instanceof c.OctreeNode?e.root:new c.OctreeNode(e)};c.Octree.prototype={root_set:function(e){if(e instanceof c.OctreeNode){this.root=e;this.root.properties_update_cascade()}},add:function(k,f){var m,g,j,n,e,h;if(k instanceof c.OctreeObjectData){k=k.object}j=this.objects.indexOf(k);if(j===-1){this.objects.push(k);this.update_object_world_matrix(k);if(f===true){n=k.geometry;e=n.faces;for(m=0,g=e.length;m<g;m++){this.add_object_data(k,e[m])}}else{this.add_object_data(k)}}},add_object_data:function(f,g){var e=new c.OctreeObjectData(f,g);this.objectsData.push(e);this.root.add_object(e)},remove:function(h){var j,e,g=h,f,k;if(h instanceof c.OctreeObjectData){h=h.object}f=this.objects.indexOf(h);if(f!==-1){this.objects.splice(f,1);k=this.root.remove_object(g);for(j=0,e=k.length;j<e;j++){g=k[j];f=this.objectsData.indexOf(g);if(f!==-1){this.objectsData.splice(f,1)}}}},extend:function(g){var j,f,e,h;if(g instanceof c.Octree){e=g.objectsData;for(j=0,f=e.length;j<f;j++){h=e[j];this.add(h,h.usesFaces())}}},update:function(){var j,e,m,g,f,k,n,h=[];for(j=0,e=this.objects.length;j<e;j++){g=this.objects[j];this.update_object_world_matrix(g)}for(j=0,e=this.objectsData.length;j<e;j++){f=this.objectsData[j];m=f.node;f.update();if(m instanceof c.OctreeNode&&!f.positionLast.equals(f.position)){n=f.indexOctant;k=m.octant_index(f);if(k!==n){h.push(f)}}}for(j=0,e=h.length;j<e;j++){f=h[j];f.node.remove_object(f);this.root.add_object(f)}},search:function(n,q,p,s){var m,h,g,u,t,j,k,f,e,r,o;u=[].concat(this.root.objects);if(b(q)!==true){q=Number.MAX_VALUE}if(s instanceof c.Vector3){s=this.utilVec31Search.copy(s).normalize();o=this.utilVec32Search.set(1,1,1).divideSelf(s)}for(m=0,h=this.root.nodesIndices.length;m<h;m++){g=this.root.nodesByIndex[this.root.nodesIndices[m]];u=g.search(n,q,u,s,o)}if(p===true){k=[];e=[];for(m=0,h=u.length;m<h;m++){t=u[m];j=t.object;r=e.indexOf(j);if(r===-1){f={object:j,faces:[]};k.push(f);e.push(j)}else{f=k[r]}if(typeof t.faces!=="undefined"){f.faces.push(t.faces)}}}else{k=u}return k},update_object_world_matrix:function(g){var h,e,k=[g],j,f;j=g.parent;while(j){k.push(j);j=j.parent}for(h=0,e=k.length;h<e;h++){j=k[h];if(j.matrixWorldNeedsUpdate===true){f=j}}if(typeof f!=="undefined"){f.updateMatrixWorld()}},depth_end:function(){return this.root.depth_end()},node_count_end:function(){return this.root.node_count_end()},object_count_end:function(){return this.root.object_count_end()},to_console:function(){this.root.to_console()}};c.OctreeObjectData=function(e,f){this.utilVec31FaceBounds=new c.Vector3();this.object=e;this.faces=f;this.radius=0;this.position=new c.Vector3();if(this.object instanceof c.Object3D){this.update()}this.positionLast=this.position.clone()};c.OctreeObjectData.prototype={update:function(){if(this.usesFaces()){this.radius=this.face_bounding_radius(this.object,this.faces);this.object.matrixWorld.multiplyVector3(this.position.copy(this.faces.centroid))}else{this.radius=this.object.geometry instanceof c.Geometry?this.object.geometry.boundingSphere.radius:this.object.boundRadius;this.position.copy(this.object.matrixWorld.getPosition())}this.radius=this.radius*Math.max(this.object.scale.x,this.object.scale.y,this.object.scale.z)},face_bounding_radius:function(g,m){var p=g instanceof c.Mesh?g.geometry:g,k=p.vertices,e=m.centroid,q=k[m.a],o=k[m.b],n=k[m.c],j,f=this.utilVec31FaceBounds,h;if(m instanceof c.Face4){j=k[m.d];e.add(q,o).addSelf(n).addSelf(j).divideScalar(4);h=Math.max(f.sub(e,q).length(),f.sub(e,o).length(),f.sub(e,n).length(),f.sub(e,j).length())}else{e.add(q,o).addSelf(n).divideScalar(3);h=Math.max(f.sub(e,q).length(),f.sub(e,o).length(),f.sub(e,n).length())}return h},usesFaces:function(){return this.faces instanceof c.Face3||this.faces instanceof c.Face4}};c.OctreeNode=function(e){this.utilVec31Branch=new c.Vector3();this.utilVec31Expand=new c.Vector3();this.utilVec31Ray=new c.Vector3();e=e||{};if(e.tree instanceof c.Octree){this.tree=e.tree}else{if(parent instanceof c.OctreeNode!==true){e.root=this;this.tree=new c.Octree(e)}}this.id=this.tree.nodeCount++;this.position=e.position instanceof c.Vector3?e.position:new c.Vector3();this.radius=b(e.radius)&&e.radius>0?e.radius:1;this.indexOctant=e.indexOctant;this.depth=0;this.reset();this.parent_set(e.parent);this.overlap=this.radius*this.tree.overlapPct;this.radiusOverlap=this.radius+this.overlap;this.left=this.position.x-this.radiusOverlap;this.right=this.position.x+this.radiusOverlap;this.bottom=this.position.y-this.radiusOverlap;this.top=this.position.y+this.radiusOverlap;this.back=this.position.z-this.radiusOverlap;this.front=this.position.z+this.radiusOverlap;if(this.tree.scene){this.visual=new c.Mesh(new c.CubeGeometry(this.radiusOverlap*2,this.radiusOverlap*2,this.radiusOverlap*2),new c.MeshBasicMaterial({color:16711680,wireframe:true,wireframeLinewidth:1}));this.visual.position.copy(this.position);this.tree.scene.add(this.visual)}};c.OctreeNode.prototype={parent_set:function(e){if(e!==this&&this.parent!==e){this.parent=e;this.properties_update_cascade()}},properties_update_cascade:function(){var f,e;if(this._parent instanceof c.OctreeNode){this.tree=this._parent.tree;this.depth=this._parent.depth+1}else{this.depth=0}for(f=0,e=this.nodesIndices.length;f<e;f++){this.nodesByIndex[this.nodesIndices[f]].properties_update_cascade()}},reset:function(f,k){var g,e,h,j=this.nodesIndices||[],m=this.nodesByIndex;this.objects=[];this.nodesIndices=[];this.nodesByIndex={};for(g=0,e=j.length;g<e;g++){h=m[j[g]];h.parent_set(undefined);if(f===true){h.reset(f,k)}}if(k===true&&this.visual&&this.visual.parent){this.visual.parent.remove(this.visual)}},add_node:function(f,e){e=f.indexOctant=b(e)?e:b(f.indexOctant)?f.indexOctant:this.octant_index(f);if(this.nodesIndices.indexOf(e)===-1){this.nodesIndices.push(e)}this.nodesByIndex[e]=f;if(f.parent!==this){f.parent_set(this)}},remove_node:function(f){var g=-1,e,h;if(f instanceof c.OctreeNode&&this.nodesByIndex[f.indexOctant]===f){h=f;g=h.indexOctant}else{if(b(f)){g=f}else{for(e in this.nodesByIndex){h=this.nodesByIndex[e];if(h===f){g=e;break}}}}if(g!==-1){e=this.nodesIndices.indexOf(g);this.nodesIndices.splice(e,1);h=h||this.nodesByIndex[g];delete this.nodesByIndex[g];if(h.parent===this){h.parent_set(undefined)}}},add_object:function(f){var e,g,h;g=this.octant_index(f);if(g>-1&&this.nodesIndices.length>0){h=this.branch(g);h.add_object(f)}else{if(g<-1&&this.parent instanceof c.OctreeNode){this.parent.add_object(f)}else{e=this.objects.indexOf(f);if(e===-1){this.objects.push(f)}f.node=this;this.grow_check()}}},add_objects_no_check:function(h){var g,e,f;for(g=0,e=h.length;g<e;g++){f=h[g];this.objects.push(f);f.node=this}},remove_object:function(f){var g,e,h,j;j=this.remove_object_end(f,{searchComplete:false,nodesRemovedFrom:[],objectsDataRemoved:[]});h=j.nodesRemovedFrom;if(h.length>0){for(g=0,e=h.length;g<e;g++){h[g].shrink()}}return j.objectsDataRemoved},remove_object_end:function(h,n){var j,e,g=-1,f,m,k;if(h instanceof c.OctreeObjectData){g=this.objects.indexOf(h);if(g!==-1){this.objects.splice(g,1);h.node=undefined;n.objectsDataRemoved.push(h);n.searchComplete=k=true}}else{for(j=this.objects.length-1;j>=0;j--){f=this.objects[j];if(f.object===h){this.objects.splice(j,1);f.node=undefined;n.objectsDataRemoved.push(f);k=true;if(typeof f.faces==="undefined"){n.searchComplete=true;break}}}}if(k===true){n.nodesRemovedFrom.push(this)}if(n.searchComplete!==true){for(j=0,e=this.nodesIndices.length;j<e;j++){m=this.nodesByIndex[this.nodesIndices[j]];n=m.remove_object_end(h,n);if(n.searchComplete===true){break}}}return n},grow_check:function(){if(this.objects.length>this.tree.objectsThreshold&&this.tree.objectsThreshold>0){this.grow()}},grow:function(){var g,e,m=[],j=[],k=[],h=[],f=[];for(i=0,l=this.objects.length;i<l;i++){e=this.objects[i];g=this.octant_index(e);if(g>-1){k.push(e);h.push(g)}else{if(g<-1){m.push(e);j.push(g)}else{f.push(e)}}}if(k.length>0){f=f.concat(this.split(k,h))}if(m.length>0){f=f.concat(this.expand(m,j))}this.objects=f;this.merge_check()},split:function(n,f){var h,e,k,g,m,j;if(this.tree.depthMax<0||this.depth<this.tree.depthMax){n=n||this.objects;f=f||[];j=[];for(h=0,e=n.length;h<e;h++){g=n[h];k=b(f[h])?f[h]:this.octant_index(g);if(k>-1){m=this.branch(k);m.add_object(g)}else{j.push(g)}}if(n===this.objects){this.objects=j}}else{j=this.objects}return j},branch:function(j){var k,h,f,g,m,e;if(this.nodesByIndex[j] instanceof c.OctreeNode){k=this.nodesByIndex[j]}else{f=(this.radiusOverlap)*0.5;h=f*this.tree.overlapPct;g=f-h;m=this.utilVec31Branch.set(j&1?g:-g,j&2?g:-g,j&4?g:-g);e=new c.Vector3().add(this.position,m);k=new c.OctreeNode({tree:this.tree,parent:this,position:e,radius:f,indexOctant:j});this.add_node(k,j)}return k},expand:function(f,J){var F,E,N,H,K,g,s,w,o,y=this.tree.INDEX_OUTSIDE_MAP,u,B,z,x,m,j,D,C,A,I,G,r,q,p,e,k,L,h,v,n=this.utilVec31Expand,M,t;if(this.tree.depthMax<0||this.tree.root.depth_end()<this.tree.depthMax){f=f||this.objects;J=J||[];H=[];K=[];for(F=0,E=y.length;F<E;F++){y[F].count=0}for(F=0,E=f.length;F<E;F++){N=f[F];g=b(J[F])?J[F]:this.octant_index(N);if(g<-1){s=-g-this.tree.INDEX_OUTSIDE_OFFSET;if(s&this.tree.FLAG_POS_X){y[this.tree.INDEX_OUTSIDE_POS_X].count++}else{if(s&this.tree.FLAG_NEG_X){y[this.tree.INDEX_OUTSIDE_NEG_X].count++}}if(s&this.tree.FLAG_POS_Y){y[this.tree.INDEX_OUTSIDE_POS_Y].count++}else{if(s&this.tree.FLAG_NEG_Y){y[this.tree.INDEX_OUTSIDE_NEG_Y].count++}}if(s&this.tree.FLAG_POS_Z){y[this.tree.INDEX_OUTSIDE_POS_Z].count++}else{if(s&this.tree.FLAG_NEG_Z){y[this.tree.INDEX_OUTSIDE_NEG_Z].count++}}K.push(N)}else{H.push(N)}}if(K.length>0){u=y.slice(0);u.sort(function(P,O){return O.count-P.count});B=u[0];m=B.index|1;D=u[1];C=u[2];z=(D.index|1)!==m?D:C;j=z.index|1;D=u[2];C=u[3];A=u[4];I=D.index|1;G=C.index|1;x=I!==m&&I!==j?D:G!==m&&G!==j?C:A;r=B.x+z.x+x.x;q=B.y+z.y+x.y;p=B.z+z.z+x.z;g=this.octant_index_from_xyz(r,q,p);o=this.octant_index_from_xyz(-r,-q,-p);e=this.overlap;k=this.radius;h=this.tree.overlapPct>0?e/((0.5*this.tree.overlapPct)*(1+this.tree.overlapPct)):k*2;v=h*this.tree.overlapPct;L=(h+v)-(k+e);n.set(g&1?L:-L,g&2?L:-L,g&4?L:-L);M=new c.Vector3().add(this.position,n);t=new c.OctreeNode({tree:this.tree,position:M,radius:h});t.add_node(this,o);this.tree.root_set(t);for(F=0,E=K.length;F<E;F++){this.tree.root.add_object(K[F])}}if(f===this.objects){this.objects=H}}else{H=f}return H},shrink:function(){this.merge_check();this.tree.root.contract_check()},merge_check:function(){var e=this,f;while(e.parent instanceof c.OctreeNode&&e.object_count_end()<this.tree.objectsThreshold){f=e;e=e.parent}if(e!==this){e.merge(f)}},merge:function(g){var m,e,h,f,n;g=d(g);for(m=0,e=g.length;m<e;m++){n=g[m];this.add_objects_no_check(n.objects_end());n.reset(true,true);this.remove_node(n.indexOctant,n)}this.merge_check()},contract_check:function(){var j,g,m,k,f,e,h;if(this.nodesIndices.length>0){e=0;h=this.objects.length;for(j=0,g=this.nodesIndices.length;j<g;j++){m=this.nodesByIndex[this.nodesIndices[j]];k=m.object_count_end();h+=k;if(f instanceof c.OctreeNode===false||k>e){f=m;e=k}}h-=e;if(h<this.tree.objectsThreshold&&f instanceof c.OctreeNode){this.contract(f)}}},contract:function(h){var f,e,g;for(f=0,e=this.nodesIndices.length;f<e;f++){g=this.nodesByIndex[this.nodesIndices[f]];if(g!==h){h.add_objects_no_check(g.objects_end());g.reset(true,true)}}h.add_objects_no_check(this.objects);this.reset(false,true);this.tree.root_set(h);h.contract_check()},octant_index:function(v){var n,h,k,q,o=this.position,t=this.radiusOverlap,u=this.overlap,m,j,g,s,r,p,f,e=0;if(v instanceof c.OctreeObjectData){q=v.radius;k=v.position;v.positionLast.copy(k)}else{if(v instanceof c.OctreeNode){k=v.position;q=0}}m=k.x-o.x;j=k.y-o.y;g=k.z-o.z;s=Math.abs(m);r=Math.abs(j);p=Math.abs(g);f=Math.max(s,r,p);if(f+q>t){if(s+q>t){e=e^(m>0?this.tree.FLAG_POS_X:this.tree.FLAG_NEG_X)}if(r+q>t){e=e^(j>0?this.tree.FLAG_POS_Y:this.tree.FLAG_NEG_Y)}if(p+q>t){e=e^(g>0?this.tree.FLAG_POS_Z:this.tree.FLAG_NEG_Z)}v.indexOctant=-e-this.tree.INDEX_OUTSIDE_OFFSET;return v.indexOctant}if(m-q>-u){e=e|1}else{if(!(m+q<u)){v.indexOctant=this.tree.INDEX_INSIDE_CROSS;return v.indexOctant}}if(j-q>-u){e=e|2}else{if(!(j+q<u)){v.indexOctant=this.tree.INDEX_INSIDE_CROSS;return v.indexOctant}}if(g-q>-u){e=e|4}else{if(!(g+q<u)){v.indexOctant=this.tree.INDEX_INSIDE_CROSS;return v.indexOctant}}v.indexOctant=e;return v.indexOctant},octant_index_from_xyz:function(e,h,g){var f=0;if(e>0){f=f|1}if(h>0){f=f|2}if(g>0){f=f|4}return f},search:function(h,m,o,n,j){var g,f,e,k;if(n){k=this.intersect_ray(h,n,m,j)}else{k=this.intersect_sphere(h,m)}if(k===true){o=o.concat(this.objects);for(g=0,f=this.nodesIndices.length;g<f;g++){e=this.nodesByIndex[this.nodesIndices[g]];o=e.search(h,m,o,n)}}return o},intersect_sphere:function(f,e){var k=e*e,j=f.x,h=f.y,g=f.z;if(j<this.left){k-=Math.pow(j-this.left,2)}else{if(j>this.right){k-=Math.pow(j-this.right,2)}}if(h<this.bottom){k-=Math.pow(h-this.bottom,2)}else{if(h>this.top){k-=Math.pow(h-this.top,2)}}if(g<this.back){k-=Math.pow(g-this.back,2)}else{if(g>this.front){k-=Math.pow(g-this.front,2)}}return k>=0},intersect_ray:function(r,q,e,p){if(typeof p==="undefined"){p=this.utilVec31Ray.set(1,1,1).divideSelf(q)}var o=(this.left-r.x)*p.x,n=(this.right-r.x)*p.x,k=(this.bottom-r.y)*p.y,j=(this.top-r.y)*p.y,h=(this.back-r.z)*p.z,g=(this.front-r.z)*p.z,m=Math.min(Math.min(Math.max(o,n),Math.max(k,j)),Math.max(h,g)),f;if(m<0){return false}f=Math.max(Math.max(Math.min(o,n),Math.min(k,j)),Math.min(h,g));if(f>m||f>e){return false}return true},depth_end:function(h){var f,e,g;if(this.nodesIndices.length>0){for(f=0,e=this.nodesIndices.length;f<e;f++){g=this.nodesByIndex[this.nodesIndices[f]];h=g.depth_end(h)}}else{h=!h||this.depth>h?this.depth:h}return h},node_count_end:function(){return this.tree.root.node_count_cascade()+1},node_count_cascade:function(){var f,e,g=this.nodesIndices.length;for(f=0,e=this.nodesIndices.length;f<e;f++){g+=this.nodesByIndex[this.nodesIndices[f]].node_count_cascade()}return g},objects_end:function(h){var f,e,g;h=(h||[]).concat(this.objects);for(f=0,e=this.nodesIndices.length;f<e;f++){g=this.nodesByIndex[this.nodesIndices[f]];h=g.objects_end(h)}return h},object_count_end:function(){var f,e,g=this.objects.length;for(f=0,e=this.nodesIndices.length;f<e;f++){g+=this.nodesByIndex[this.nodesIndices[f]].object_count_end()}return g},object_count_start:function(){var f=this.objects.length,e=this.parent;while(e instanceof c.OctreeNode){f+=e.objects.length;e=e.parent}return f},to_console:function(h){var f,e,g,j="   ";h=typeof h==="string"?h:j;console.log((this.parent?h+" octree NODE > ":" octree ROOT > "),this," // id: ",this.id," // indexOctant: ",this.indexOctant," // position: ",this.position.x,this.position.y,this.position.z," // radius: ",this.radius," // depth: ",this.depth);console.log((this.parent?h+" ":" "),"+ objects ( ",this.objects.length," ) ",this.objects);console.log((this.parent?h+" ":" "),"+ children ( ",this.nodesIndices.length," )",this.nodesIndices,this.nodesByIndex);for(f=0,e=this.nodesIndices.length;f<e;f++){g=this.nodesByIndex[this.nodesIndices[f]];g.to_console(h+j)}}};c.Ray.prototype.intersectOctreeObject=function(g,f){var j,k,h,e;if(g.object instanceof c.Object3D){k=g;g=k.object;e=k.faces;h=g.geometry.faces;if(e.length>0){g.geometry.faces=e}j=this.intersectObject(g,f);if(e.length>0){g.geometry.faces=h}}else{j=this.intersectObject(g,f)}return j};c.Ray.prototype.intersectOctreeObjects=function(j,f){var g,e,h=[];for(g=0,e=j.length;g<e;g++){h=h.concat(this.intersectOctreeObject(j[g],f))}return h}}(THREE));